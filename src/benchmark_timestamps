#!/bin/bash

trap _cleanup EXIT

_cleanup() {
    docker rm -f stress dc-warmup &> /dev/null

    kill $STATS_ID &> /dev/null

    docker logs -t dc-client | grep -v -e "starting receive" -e "Creating worker" -e "num_worker" > "$LOGFILE.txt"

    echo "timestamp, timeDiff, rps, requests, gets, sets, hits, misses, avg_lat, 90th, 95th, 99th, std, min, max, avgGetSize" > "${LOGFILE}_lat.csv" 
    sed -n '/timeDiff/{n;p}'    "$LOGFILE.txt" | awk '$1 = $1","' | sed 1d >> "${LOGFILE}_lat.csv"

    echo -n "timestamp, " > "${LOGFILE}_osr.csv"
    for i in $(seq $CLIENT_WORKERS); do
        if [[ $i = $CLIENT_WORKERS ]]; then
            echo "osr$i" >> "${LOGFILE}_osr.csv"
        else
            echo -n "osr$i, " >> "${LOGFILE}_osr.csv"
        fi
    done
    sed -n '/Outstanding/{n;p}' "$LOGFILE.txt" | awk '$1 = $1","' | sed 1d >> "${LOGFILE}_osr.csv"

    docker rm -f dc-client &> /dev/null

    echo "Waiting for stats cleanup ..."
    wait $STATS_ID

    docker rm -f dc-server &> /dev/null

    echo "Cleanup performed"
    #[[ -n $(jobs -p) ]] && kill -9 $(jobs -p)
}


if [ $# = 2 ]; then
    TAG=${1}
    RPS=${2}
else
    echo "Run tag and RPS are required arguments" >&2
    exit
fi

OUTDIR="/workspace/output/$TAG"
LOGDIR="$OUTDIR/logs"
STATSDIR="$OUTDIR/stats"
LOGFILE="$LOGDIR/$RPS"
STATSFILE="$STATSDIR/$RPS"

mkdir -p $OUTDIR $LOGDIR $STATSDIR

export CONNECTIONS=$(($CPW * $CLIENT_WORKERS))

if [[ -f "$OUTDIR/params.txt" ]]; then
    echo "$RPS" >> $OUTDIR/params.txt
else
    printf "$(date)\nTag: $TAG\nRuntime: $RUNTIME\nStats interval: $STATS_INTERVAL\nTotal connections: $CONNECTIONS\n" > "$OUTDIR/params.txt"
    printf "Client workers: $CLIENT_WORKERS\nStreaming stats: $STREAM_STATS\nUsing stress: $USE_STRESS\n" >> "$OUTDIR/params.txt"
    printf "Server workers: $SERVER_WORKERS\nServer memory: $SERVER_MEMORY\nServer minimum allocation: $SERVER_MIN\n" >> "$OUTDIR/params.txt"
    printf "RPS:\n$RPS\n" >> "$OUTDIR/params.txt"
fi

printf "\n============================================================================================\n"
printf "Benchmarking memcached with $RPS attempted RPS, for $(expr $RUNTIME / 60) minutes, reporting every $STATS_INTERVAL seconds"
printf "\n============================================================================================\n\n"


docker rm -f dc-server dc-client dc-warmup stress &> /dev/null

# Start server
export SERVER_ID=$(docker run -d \
    --net dc \
    --name dc-server \
    --cgroup-parent=/server.slice/ \
    cloudsuite/data-caching:server \
        -t $SERVER_WORKERS -m $SERVER_MEMORY -n $SERVER_MIN)
echo "Running dc-server: $SERVER_ID"

# Warm up server
echo -n "Running dc-warmup: "
docker run -d --rm \
    --net dc \
    --name dc-warmup \
    --cgroup-parent=/client.slice/ \
    -v /workspace/bin:/volume \
    --entrypoint /volume/warmup.sh \
    --env-file /workspace/bin/conf.env \
    -e CONNECTIONS \
    jonassa/data-caching:client

echo "Warming up the server ..."
docker container wait dc-warmup

# Collect stats
if [ $STREAM_STATS = 1 ]; then
    stats_stream "$STATSFILE" &
else
    stats "$STATSFILE" $STATS_INTERVAL &
fi

STATS_ID=$!
echo "Collecting stats ($STATS_ID)"

# Benchmark server
echo -n "Running dc-client: "
docker run -d \
    --net dc \
    --name dc-client \
    --cgroup-parent=/client.slice/ \
    -v /workspace/bin:/volume \
    --env-file /workspace/bin/conf.env \
    -e CONNECTIONS \
    jonassa/data-caching:client $RPS

# Run stress-ng
if [ $USE_STRESS = 1 ]; then
    echo -n "Running stress-ng: "
    docker run -d --rm \
        --name stress \
        --cgroup-parent=/server.slice/ \
        polinux/stress-ng \
            --cpu 18 \
            --cpu-load 50 \
            --metrics-brief \
            --timeout 0
fi

echo "Benchmarking the server ..."
docker container wait dc-client

echo "--------------------------------"
echo "Benchmark at $RPS rps complete"
echo "--------------------------------"

