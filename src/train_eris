#!/bin/bash

cd /opt/platform-resource-manager
source .direnv/python-3.6.8/bin/activate
cd eris

# test -d logs || mkdir logs
# LOGDIR="logs/$(date +%m_%d_%H:%M)"

# [[ -d $LOGDIR ]] && rm -rf "$LOGDIR"
# mkdir "$LOGDIR"

rm metric.csv util.csv && echo "Removed metric.csv and util.csv"
test -f threshold.json && mv threshold.json threshold.json.old

echo "Workload configuration:"
bat workload.json 2> /dev/null || cat workload.json

echo "Starting extended run"
extended_run & extended_pid=$!

echo "Collecting data ..."
# numactl --cpunodebind=0 --membind=0 \
    # python3 eris.py --collect-metrics --record workload.json &> "$LOGDIR/collect.log"
    # python eris.py --collect-metrics --record workload.json &> logs/collect.log
    python eris.py --collect-metrics --record workload.json

echo "Analyzing data ... "
# python3 analyze.py workload.json &> "$LOGDIR/analyze.log"
# python analyze.py workload.json &> logs/analyze.log
python analyze.py workload.json 

trap terminate SIGINT
terminate() {
    echo Stopping extended run
    kill -0 $extended_pid && kill -INT $extended_pid
}
