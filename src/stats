#!/bin/bash

RUNDIR="$1"

STATS_FILE="$RUNDIR/stats"
RAPL_FILE="$RUNDIR/rapl.csv"

cleanup() {
    pids=$(jobs -p)
    for pid in $pids; do
        kill $pid &> /dev/null
    done
    wait $pids &> /dev/null

    for tmp in $RUNDIR/stats*.tmp; do
        sed '$d' "$tmp" | jq  -s . > "${tmp%.tmp}.json" && rm "$tmp"
    done
}
trap cleanup EXIT

for container in "${@:2}"; do
    read cname cid <<< $container
    :>| "${STATS_FILE}_${cname}.tmp"
    curl -sS --unix-socket /var/run/docker.sock "http:/v1.26/containers/$cid/stats?stream=1" > "${STATS_FILE}_${cname}.tmp" &
done

while true; do
    # RAPL timestamp (or any other stats we gather here in the future)
    # NOT accurate for docker stats API (use "read" in the response)
    timestamp=$(date -u --rfc-3339=ns)

    # Assuming package 0 corresponds to node 0
    energy=$(/workspace/bin/rapl -s | grep package-0 | awk '{print $3}')

    echo "$timestamp, $energy" >> "$RAPL_FILE"

    # echo "0" > "/sys/class/powercap/intel-rapl:0/energy_uj"
done

